% RA, 2020-10-17

function environment
	STICKS = randi([0, 16], [1, 100]);
	
	for sticks = STICKS
		disp(['===========']);
		disp(['ENV: There are now ' num2str(sticks) ' sticks.']);
	
		shared_constants;

		bits = [0, 0, 0, 0, 0];

		player = Player;

		% Cool down
		bits(1) = NO_INPUT;
		
		disp(['ENV: Waiting for Player to get ready.']);

		while (player.response1 > ALMOST_ZERO)
			player = player.process(bits);
		end
		readout = interpret(player);
		
		assert(readout(1) == 0);
		
		disp(['ENV: Player is ready.']);

		% Signal new input
		bits = to_bits(sticks);
		bits(1) = ATTENTION;

		disp(['ENV: Sending stick status to player.']);
		disp(['ENV: Sending stick status to player.']);
		
		while (player.response1 < ALMOST_ONE)
			player = player.process(bits);
		end
		readout = interpret(player);

		player_took = readout(2) * 2 + readout(3);
		disp(['ENV: There were ' num2str(sticks) ' sticks. Player TOOK ' num2str(player_took) ' STICKS.']);

% 		% Cool down
% 		bits(1) = NO_INPUT;
% 
% 		while (player.response1 > ALMOST_ZERO)
% 			player = player.process(bits);
% 		end
% 		interpret(player);
	
	end
end

function bits = to_bits(number)
	bits = dec2bin(number, 5) - '0';
end

function [readout] = interpret(player)
	response = [player.response1, player.response2, player.response3];
	readout = round(response);
	disp(['ENV: Readout ' num2str(readout) ' (interpreted from ' num2str(response) ')']);
end
